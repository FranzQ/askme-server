// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Verification {
  id              String   @id @default(cuid())
  verifiedEns     String   // ENS name being verified
  field           String   // full_name | dob | passport_id
  fieldHash       String   // keccak256("VerifyENS:"+field+":"+normalizedValue)
  verifierType    String   // "ens" | "world"
  verifierId      String   // ens address OR world nullifier
  ensName         String?  // only for ENS verifiers
  ownerSnapshot   String?  // 0x... owner address at issuance (for ENS verifiers)
  expirySnapshot  DateTime? // ENS expiry at issuance (for ENS verifiers)
  methodUrl       String?  // "how we verify" link
  status          String   @default("active") // active | revoked | expired
  sig             String?  // EIP-712 signature (optional for world verifiers)
  attestationUid  String?  // EAS attestation UID on Base (receipt for on-chain verification)
  createdAt       DateTime @default(now())
  revokedAt       DateTime?

  @@index([verifiedEns, field, status])
  @@index([verifierType, verifierId])
  @@index([verifiedEns])
  @@index([attestationUid])
  @@unique([verifierType, verifierId, verifiedEns, field, fieldHash])
}

model VerificationRequest {
  id              String   @id @default(cuid())
  verifierAddress String   // Ethereum address of verifier
  verifierEns     String?  // ENS name of verifier at request time
  verifiedEns     String   // ENS name being verified
  field           String   // full_name, dob, or passport_id
  status          String   @default("pending") // pending, approved, rejected, expired, completed
  revealMode      String?  // "reveal" or "no-reveal" - set when approved
  requestedAt     DateTime @default(now())
  approvedAt      DateTime?
  expiresAt       DateTime? // When the reveal access expires (e.g., 1 hour after approval)
  completedAt     DateTime? // When attestation was created
  
  // Temporary storage of revealed value (encrypted or plain for MVP)
  // In production, this should be encrypted
  // Only set when revealMode = "reveal"
  revealedValue   String?  // Only set when approved with reveal mode, cleared after expiry
  
  // Store the fieldHash when approved (for no-reveal mode verification)
  fieldHash       String?  // Computed hash when approved, used to verify typed value
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([verifiedEns, status])
  @@index([verifierAddress, status])
  @@index([verifiedEns])
}

model FieldRevealLog {
  id              String   @id @default(cuid())
  requestId       String   // Reference to VerificationRequest
  verifiedEns     String   // ENS name
  field           String   // Field that was revealed
  verifierAddress String   // Verifier who saw the value
  verifierEns     String?  // ENS name of verifier
  revealedAt      DateTime @default(now())
  valueHash       String?  // Hash of the value (for audit, not the actual value)
  
  createdAt DateTime @default(now())

  @@index([verifiedEns])
  @@index([verifierAddress])
  @@index([requestId])
}

model WorldProof {
  id              String   @id @default(cuid())
  nullifierHash   String   @unique // World nullifier hash (prevents double verification)
  merkleRoot      String
  proof           String
  signal          String   // e.g., `${verifiedEns}:${fieldHash}`
  createdAt       DateTime @default(now())

  @@index([nullifierHash])
}

